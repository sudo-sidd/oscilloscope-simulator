<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oscilloscope Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .scope-display {
            flex: 1;
            padding: 20px;
            position: relative;
        }

        .screen {
            width: 100%;
            height: 80vh;
            background: #001100;
            border: 2px solid #00ff00;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }

        .grid-line {
            stroke: #00ff00;
            stroke-width: 0.5;
        }

        .grid-line-major {
            stroke: #00ff00;
            stroke-width: 1;
        }

        .trace {
            stroke: #00ff00;
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 5px #00ff00);
        }

        .trace-ch2 {
            stroke: #ffaa00;
            filter: drop-shadow(0 0 5px #ffaa00);
        }

        .controls {
            width: 300px;
            padding: 20px;
            background: #111;
            border-left: 2px solid #00ff00;
            overflow-y: auto;
            height: 100vh;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }

        .control-group h3 {
            color: #00ff00;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .control-item {
            margin-bottom: 10px;
        }

        .control-item label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #888;
        }

        .slider {
            width: 100%;
            height: 20px;
            background: #333;
            outline: none;
            border-radius: 5px;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        select {
            width: 100%;
            padding: 5px;
            background: #222;
            color: #00ff00;
            border: 1px solid #444;
            border-radius: 3px;
        }

        .status-bar {
            position: absolute;
            bottom: 10px;
            left: 20px;
            font-size: 12px;
            color: #888;
        }

        .measurements {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }

        .channel-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .channel-btn {
            padding: 5px 10px;
            background: #333;
            color: #888;
            border: 1px solid #555;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .channel-btn.active {
            background: #00ff00;
            color: #000;
        }

        .channel-btn.ch2.active {
            background: #ffaa00;
            color: #000;
        }

        .trigger-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            width: 20px;
            height: 2px;
            background: #ff0000;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scope-display">
            <div class="screen">
                <svg class="grid" width="100%" height="100%">
                    <!-- Grid will be generated by JavaScript -->
                </svg>
                <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
                    <path class="trace" id="trace1"></path>
                    <path class="trace trace-ch2" id="trace2"></path>
                </svg>
                <div class="trigger-indicator" id="triggerLine"></div>
            </div>
            <div class="measurements">
                <div>CH1: <span id="ch1-freq">1.00 kHz</span> | <span id="ch1-amp">2.50 V</span></div>
                <div>CH2: <span id="ch2-freq">0.50 kHz</span> | <span id="ch2-amp">1.80 V</span></div>
                <div>Time/Div: <span id="time-div">10 ms</span></div>
            </div>
            <div class="status-bar">
                Running | Trig: Auto | Sample Rate: 10 MS/s
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>CHANNELS</h3>
                <div class="channel-controls">
                    <button class="channel-btn active" id="ch1-btn">CH1</button>
                    <button class="channel-btn" id="ch2-btn">CH2</button>
                </div>
                <div class="control-item">
                    <label>Description</label>
                    <div id="preset-description" style="font-size:11px;color:#888;padding:5px;border:1px solid #333;border-radius:3px;min-height:40px;background:#0a0a0a;">
                        Select a preset to see description and optimal settings
                    </div>
                </div>
                <div class="control-item">
                    <label>Phase: <span id="ch2-phase-val">0°</span></label>
                    <input type="range" class="slider" id="ch2-phase-slider" min="0" max="360" value="0">
                </div>

            <div class="control-group">
                <h3>CH1 SETTINGS</h3>
                <div class="control-item">
                    <label>Waveform</label>
                    <select id="ch1-wave">
                        <option value="sine">Sine Wave</option>
                        <option value="square">Square Wave</option>
                        <option value="triangle">Triangle</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="noise">Noise</option>
                        <option value="custom">Custom Function</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Frequency: <span id="ch1-freq-val">1000 Hz</span></label>
                    <input type="range" class="slider" id="ch1-freq-slider" min="1" max="5000" value="1000">
                </div>
                <div class="control-item">
                    <label>Amplitude: <span id="ch1-amp-val">2.5 V</span></label>
                    <input type="range" class="slider" id="ch1-amp-slider" min="0.1" max="5" value="2.5" step="0.1">
                </div>
                <div class="control-item">
                    <label>Phase: <span id="ch1-phase-val">0°</span></label>
                    <input type="range" class="slider" id="ch1-phase-slider" min="0" max="360" value="0">
                </div>
            </div>

            <div class="control-group">
                <h3>CH2 SETTINGS</h3>
                <div class="control-item">
                    <label>Waveform</label>
                    <select id="ch2-wave">
                        <option value="sine">Sine Wave</option>
                        <option value="square" selected>Square Wave</option>
                        <option value="triangle">Triangle</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="noise">Noise</option>
                        <option value="custom">Custom Function</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Frequency: <span id="ch2-freq-val">500 Hz</span></label>
                    <input type="range" class="slider" id="ch2-freq-slider" min="1" max="5000" value="500">
                </div>
                <div class="control-item">
                    <label>Amplitude: <span id="ch2-amp-val">1.8 V</span></label>
                    <input type="range" class="slider" id="ch2-amp-slider" min="0.1" max="5" value="1.8" step="0.1">
                </div>
            </div>

            <div class="control-group">
                <h3>CUSTOM ANIMATIONS</h3>
                <div class="control-item">
                    <label>Custom Function (JavaScript)</label>
                    <textarea id="custom-function" rows="4" style="width:100%;background:#222;color:#00ff00;border:1px solid #444;border-radius:3px;padding:5px;font-family:monospace;font-size:11px;" placeholder="// Example: return Math.sin(t*10) * Math.cos(t*3);
// t = time, ch = channel properties
// Available: ch.frequency, ch.amplitude
return Math.sin(t * ch.frequency * 2 * Math.PI);">return Math.sin(t * ch.frequency * 2 * Math.PI);</textarea>
                </div>
                <div class="control-item">
                    <label>Animation Presets</label>
                    <select id="animation-presets">
                        <option value="">Select Preset...</option>
                        <option value="lissajous">Lissajous Figures</option>
                        <option value="heart">Parametric Heart</option>
                        <option value="spiral">Archimedean Spiral</option>
                        <option value="flower">Rose Curve (5-petal)</option>
                        <option value="batman">Batman Logo</option>
                        <option value="infinity">Figure-8 (Infinity)</option>
                        <option value="star">5-Point Star</option>
                        <option value="spirograph">Spirograph Pattern</option>
                        <option value="mandala">Mandala (8-fold)</option>
                        <option value="fractal_tree">Fractal Tree</option>
                        <option value="dragon_curve">Dragon Curve</option>
                        <option value="butterfly">Butterfly Curve</option>
                        <option value="hypotrochoid">Hypotrochoid</option>
                        <option value="celtic_knot">Celtic Knot</option>
                    </select>
                </div>
            </div>
                <div class="control-item">
                    <label>Time/Div: <span id="time-base-val">10 ms</span></label>
                    <input type="range" class="slider" id="time-base-slider" min="1" max="20" value="10">
                </div>
                <div class="control-item">
                    <label>Trigger Level: <span id="trigger-val">0 V</span></label>
                    <input type="range" class="slider" id="trigger-slider" min="-5" max="5" value="0" step="0.1">
                </div>
            <div class="control-group">
                <h3>PATTERN RECORDING</h3>
                <div class="control-item">
                    <label>Recording Control</label>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <button id="record-btn" style="padding:5px 10px;background:#ff4444;color:#fff;border:none;border-radius:3px;cursor:pointer;flex:1;">● REC</button>
                        <button id="play-btn" style="padding:5px 10px;background:#44ff44;color:#000;border:none;border-radius:3px;cursor:pointer;flex:1;">▶ PLAY</button>
                        <button id="stop-btn" style="padding:5px 10px;background:#888;color:#fff;border:none;border-radius:3px;cursor:pointer;flex:1;">⏹ STOP</button>
                    </div>
                </div>
                <div class="control-item">
                    <label>Recording Duration: <span id="record-duration">0.0s</span></label>
                    <div style="font-size:11px;color:#666;">Status: <span id="record-status">Ready</span></div>
                </div>
                <div class="control-item">
                    <label>Recorded Patterns</label>
                    <select id="recording-list" style="width:100%;margin-bottom:5px;">
                        <option value="">No recordings</option>
                    </select>
                    <button id="clear-recordings" style="width:100%;padding:5px;background:#ff6666;color:#fff;border:none;border-radius:3px;cursor:pointer;">Clear All</button>
                </div>
            </div>

    <script src="js/waveform-generator.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/recording-manager.js"></script>
    <script src="js/grid-renderer.js"></script>
    <script>
/**
 * Oscilloscope - Main oscilloscope simulator class
 * Coordinates all modules and manages the main animation loop
 */
class Oscilloscope {
    constructor() {
        // Initialize canvas dimensions
        this.canvas = {
            width: 0,
            height: 0
        };

        // Initialize modules
        this.waveformGenerator = new WaveformGenerator();
        this.uiController = new UIController(this);
        this.recordingManager = new RecordingManager(this);
        this.gridRenderer = new GridRenderer(this);

        // Recording system state
        this.recording = {
            isRecording: false,
            isPlaying: false,
            recordings: [],
            data: [],
            startTime: 0,
            duration: 0,
            currentPlayback: null,
            playbackStart: 0
        };

        // Channel configurations
        this.channels = {
            ch1: {
                enabled: true,
                wave: 'sine',
                frequency: 1000,
                amplitude: 2.5,
                phase: 0
            },
            ch2: {
                enabled: false,
                wave: 'square',
                frequency: 500,
                amplitude: 1.8,
                phase: 0
            }
        };

        // Oscilloscope settings
        this.timeBase = 10000; // microseconds per division
        this.triggerLevel = 0;
        this.time = 0;
        this.lastTime = 0;

        // Animation presets for complex waveforms
        this.animationPresets = {
                    lissajous: {
                        name: "Lissajous Figures",
                        description: "Classic XY patterns with harmonic ratios",
                        ch1: (t, ch) => Math.sin(t * ch.frequency * 2 * Math.PI),
                        ch2: (t, ch) => Math.sin(t * ch.frequency * 2 * Math.PI * 1.5),
                        ch1Freq: 60,
                        ch2Freq: 90,
                        ch1Amp: 2.5,
                        ch2Amp: 2.5,
                        ch1Phase: 0,
                        ch2Phase: 90,
                        timeBase: 20000, // 20ms/div for 2-3 complete cycles
                        triggerLevel: 0,
                        sampleRate: "high"
                    },
                    heart: {
                        name: "Parametric Heart",
                        description: "Mathematical heart curve using parametric equations",
                        ch1: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.8;
                            return 16 * Math.pow(Math.sin(theta), 3) / 18;
                        },
                        ch2: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.8;
                            return (13 * Math.cos(theta) - 5 * Math.cos(2*theta) - 2 * Math.cos(3*theta) - Math.cos(4*theta)) / 18;
                        },
                        ch1Freq: 25,
                        ch2Freq: 25,
                        ch1Amp: 2.8,
                        ch2Amp: 2.8,
                        ch1Phase: 0,
                        ch2Phase: 0,
                        timeBase: 50000, // 50ms/div for complete heart cycle
                        triggerLevel: -0.5,
                        sampleRate: "high"
                    },
                    spiral: {
                        name: "Archimedean Spiral",
                        description: "Expanding spiral with controlled growth rate",
                        ch1: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.15;
                            const radius = Math.min(1.5, (theta % (Math.PI * 6)) / (Math.PI * 2));
                            return Math.sin(theta) * radius;
                        },
                        ch2: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.15;
                            const radius = Math.min(1.5, (theta % (Math.PI * 6)) / (Math.PI * 2));
                            return Math.cos(theta) * radius;
                        },
                        ch1Freq: 120,
                        ch2Freq: 120,
                        ch1Amp: 2.2,
                        ch2Amp: 2.2,
                        ch1Phase: 0,
                        ch2Phase: 90,
                        timeBase: 10000, // 10ms/div for smooth spiral motion
                        triggerLevel: 0,
                        sampleRate: "high"
                    },
                    flower: {
                        name: "Rose Curve (5-petal)",
                        description: "Mathematical rose with 5 petals using polar coordinates",
                        ch1: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.4;
                            const r = Math.abs(Math.sin(5 * theta));
                            return r * Math.sin(theta);
                        },
                        ch2: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.4;
                            const r = Math.abs(Math.sin(5 * theta));
                            return r * Math.cos(theta);
                        },
                        ch1Freq: 50,
                        ch2Freq: 50,
                        ch1Amp: 2.8,
                        ch2Amp: 2.8,
                        ch1Phase: 0,
                        ch2Phase: 90,
                        timeBase: 50000, // 50ms/div for complete flower
                        triggerLevel: 0,
                        sampleRate: "high"
                    },
                    batman: {
                        name: "Batman Logo",
                        description: "Stylized Batman logo using piecewise functions",
                        ch1: (t, ch) => {
                            const x = ((t * ch.frequency * 2 * Math.PI * 0.2) % (2 * Math.PI)) - Math.PI;
                            const absX = Math.abs(x);
                            if (absX <= 0.5) return 2.5 * Math.sqrt(1 - Math.pow(absX / 0.5, 2));
                            if (absX <= 0.75) return 1.5;
                            if (absX <= 1) return 2.5 * Math.sqrt(1 - Math.pow((absX - 1) / 0.25, 2));
                            return 0.9 * Math.sqrt(Math.max(0, 1 - Math.pow((absX - 1) / 1.57, 2)));
                        },
                        ch2: (t, ch) => {
                            const x = ((t * ch.frequency * 2 * Math.PI * 0.2) % (2 * Math.PI)) - Math.PI;
                            const absX = Math.abs(x);
                            if (absX <= 0.75) return 2.2;
                            if (absX <= 1) return 2.2 - 1.3 * Math.pow((absX - 0.75) / 0.25, 2);
                            return Math.max(-2.2, -2.2 * Math.sqrt(Math.max(0, 1 - Math.pow((absX - 1) / 1.57, 2))));
                        },
                        ch1Freq: 18,
                        ch2Freq: 18,
                        ch1Amp: 1.8,
                        ch2Amp: 1.8,
                        ch1Phase: 0,
                        ch2Phase: 0,
                        timeBase: 100000, // 100ms/div for complete logo
                        triggerLevel: 0,
                        sampleRate: "medium"
                    },
                    infinity: {
                        name: "Figure-8 (Infinity)",
                        description: "Perfect figure-eight pattern with controlled timing",
                        ch1: (t, ch) => Math.sin(t * ch.frequency * 2 * Math.PI),
                        ch2: (t, ch) => Math.sin(t * ch.frequency * 4 * Math.PI),
                        ch1Freq: 80,
                        ch2Freq: 80,
                        ch1Amp: 2.5,
                        ch2Amp: 2.0,
                        ch1Phase: 0,
                        ch2Phase: 0,
                        timeBase: 15000, // 15ms/div
                        triggerLevel: 0,
                        sampleRate: "high"
                    },
                    star: {
                        name: "5-Point Star",
                        description: "Geometric star pattern with sharp points",
                        ch1: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.4;
                            const angle = theta % (2 * Math.PI);
                            const starAngle = Math.floor(angle / (2 * Math.PI / 5)) * (2 * Math.PI / 5);
                            const r = 1 + 0.6 * Math.cos(5 * (angle - starAngle));
                            return r * Math.sin(angle);
                        },
                        ch2: (t, ch) => {
                            const theta = t * ch.frequency * 2 * Math.PI * 0.4;
                            const angle = theta % (2 * Math.PI);
                            const starAngle = Math.floor(angle / (2 * Math.PI / 5)) * (2 * Math.PI / 5);
                            const r = 1 + 0.6 * Math.cos(5 * (angle - starAngle));
                            return r * Math.cos(angle);
                        },
                        ch1Freq: 40,
                        ch2Freq: 40,
                        ch1Amp: 2.5,
                        ch2Amp: 2.5,
                        ch1Phase: 0,
                        ch2Phase: 90,
                        timeBase: 60000, // 60ms/div for complete star
                        triggerLevel: 0,
                        sampleRate: "high"
                    }
                };
                
                this.init();
                this.uiController.setupEventListeners();
                this.animate();
            }

            /**
             * Initialize canvas dimensions and grid
             */
            init() {
                const screen = document.querySelector('.screen');
                // Ensure we have valid dimensions
                this.canvas.width = screen.clientWidth || 800;
                this.canvas.height = screen.clientHeight || 400;
                this.gridRenderer.generateGrid();
            }

            /**
             * Main animation loop - updates display at ~60fps
             */
            animate() {
                const now = performance.now() / 1000;
                const deltaTime = now - (this.lastTime || now);
                this.lastTime = now;
                this.time = now;

                this.updateDisplay();
                requestAnimationFrame(() => this.animate());
            }

            /**
             * Update display with current waveforms, measurements, and handle recording/playback
             */
            updateDisplay() {
                // Handle recording/playback logic
                this.recordingManager.updateRecording();
                this.recordingManager.updatePlayback();

                // Update waveforms
                this.updateWaveforms();

                // Update measurements
                this.updateMeasurements();

                // Update trigger indicator
                this.updateTriggerIndicator();
            }

            /**
             * Update waveform traces
             */
            updateWaveforms() {
                const samples = 1000;
                const timeSpan = this.timeBase * 10; // 10 divisions in microseconds

                // Update CH1 trace
                if (this.channels.ch1.enabled) {
                    const trace1 = document.getElementById('trace1');
                    const path1 = this.waveformGenerator.generateWaveform(
                        'ch1', this.channels.ch1, this.time, timeSpan,
                        samples, this.canvas.width, this.canvas.height
                    );
                    trace1.setAttribute('d', path1);
                    trace1.style.display = 'block';
                } else {
                    document.getElementById('trace1').style.display = 'none';
                }

                // Update CH2 trace
                if (this.channels.ch2.enabled) {
                    const trace2 = document.getElementById('trace2');
                    const path2 = this.waveformGenerator.generateWaveform(
                        'ch2', this.channels.ch2, this.time, timeSpan,
                        samples, this.canvas.width, this.canvas.height
                    );
                    trace2.setAttribute('d', path2);
                    trace2.style.display = 'block';
                } else {
                    document.getElementById('trace2').style.display = 'none';
                }
            }

            /**
             * Update measurement displays
             */
            updateMeasurements() {
                document.getElementById('ch1-freq').textContent =
                    (this.channels.ch1.frequency / 1000).toFixed(2) + ' kHz';
                document.getElementById('ch1-amp').textContent =
                    this.channels.ch1.amplitude.toFixed(2) + ' V';
                document.getElementById('ch2-freq').textContent =
                    (this.channels.ch2.frequency / 1000).toFixed(2) + ' kHz';
                document.getElementById('ch2-amp').textContent =
                    this.channels.ch2.amplitude.toFixed(2) + ' V';
                document.getElementById('time-div').textContent = this.timeBase + ' μs';
            }

            /**
             * Update trigger indicator position
             */
            updateTriggerIndicator() {
                const triggerLine = document.getElementById('triggerLine');
                const centerY = this.canvas.height / 2;
                const triggerY = centerY - (this.triggerLevel * 50);
                triggerLine.style.top = triggerY + 'px';
            }
        }

        // Initialize oscilloscope when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new Oscilloscope();
        });
    </script>
</body>
</html>